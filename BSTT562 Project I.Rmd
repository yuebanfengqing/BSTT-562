---
title: "BSTT562 Project I"
author: "Ruizhe Chen, Hesen Li"
date: "November 29, 2018"
documentclass: article
bibliography: Reference.bib
output: 
  pdf_document:
    number_sections: true
    citation_package: natbib
fontsize: 12pt
geometry: margin = 1in
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r, echo = F}
rm(list = ls())
library(ggplot2)
library(data.table)
library(knitr)
options(digits = 4)
# read data from github

data <- read.csv('https://raw.githubusercontent.com/yuebanfengqing/BSTT-562/master/data.csv', sep = ',', header = T)

colnames(data) <- c('Lab', 'Replication', '0', '20', '100')

## transform data from wide to long 

zero <- data[,3]
twenty <- data[,4]
hundred <- data[,5]

con1 <- cbind(data[,1:2], zero)
con1$Concentration <- rep(0, 25)
colnames(con1)[3] <- 'Real'

con2 <- cbind(data[,1:2], twenty)
con2$Concentration <- rep(20, 25)
colnames(con2)[3] <- 'Real'

con3 <- cbind(data[,1:2], hundred)
con3$Concentration <- rep(100, 25)
colnames(con3)[3] <- 'Real'

p1.data <- rbind(con1, con2, con3)
```

# Abstract

In this project, we want to reproduce the results presented in Table 3 Interlaboratory Data for Cadmium from @Bhaumik2005.

# Introduction

A key characteristics of the data is its heteroscedasticity. 

# Data

This data is the experimental data fro cadmium from an interlaboratory study conducted by Ford Motor Company (J. Phillips, personal communication). These data were generated as part of a blind interlaboratory study of laboratories that hold Michigan State Drinking Water Certifications for the parameters tested. Samples were prepared by an independent source, randomized, and submitted on a weekly basis over a 5-week period. Cadmium was analyzed by inductively coupled plasma atomic emissions spectroscopy using EPA method 200.7. The data set used for this example comprised five replicates at each of three concentrations (0, 20 and 100 $\mu g/L$) in each of the $q = 5$ laboratories. Using the first replicate from the first three laboratories as the new measurement (i.e., $q' = 3$), we would like to reproduce the results of point estimates, variances, confidence intervals and simulated confidence levels for the true concentrations in each of the three cases. The data is displayed as follows:

```{r, echo = F}
kable(data, format = 'pandoc', caption = 'Interlaboratory Data for Cadmium (ug / L)')
```

# The Model

To measure the true concentration of an analyte, $x$, a simple and straightforward method is to propose a linear calibration model as: 

\begin{equation}
y = \alpha + \beta x + e
\end{equation}

with normal assumption on errors. However because our data set has heteroscedastic variances, this simple linear models fails to explain the increasing measurement variation with increasing analyte concentration, which is also commonly observed in analytic data. On the other hand, a log-linear model, for example, $y = x e^\eta$, where $\eta$ is a normal random variable with mean 0 and standard deviation $\sigma_\eta$ also fails to explain the near-constant measurement variation of $y$ for low true concentration level $(x)$ @Rocke1995. To fix these two problems at the same time, @Bhaumik2005 proposed a log-normal model that combines both types of errors:

\begin{equation}
y_{ijk} = \alpha_i + \beta_ix_je^{\eta_{ijk}} + e_{ijk},
\end{equation}

where $y_{ijk}$ is the $k$th measurement at the $j$th concentration level in the $i$ th laboratory, $i=1,2,...,q, j = 1,2,...,r, k=1,2,...,N_{ij}$, $x_j$ is the true concentration at the $j$th level, and $\alpha_i$ and $\beta_i$ are the calibration parameters for the $i$th laboratory.

In this model the $\eta_{ijk}$'s represent proportional error at higher true concentrations, and we assume that the distributions of the proportional errors remain the same for all laboratories.

Note that for this particular model, when $x$ is 0 or near 0, the model is reduced to:

\begin{align}
\begin{split}
y_{ijk} &= \alpha_i + \beta_j \times 0 \times e^{\eta_{ijk}} + e_{ijk} \\
y_{ijk} &= \alpha_i + e_{ijk} 
\end{split}
\end{align}

# Analysis

We choose the Method of Moments to estimate the model parameters. The Method of Moments is straightforward and easy to implement when observations with lower concentrations are available, which happens to be the case with our Interlaboratory Data for Cadmium.

Why do we choose the Method of Moments: A good property of MOM: the estimates obtained by MOM are asymptotically efficient.

## The Parameter Estimation Procedures (Using Data Separation Technique)

### (Partial) Estimation Using Low-Concentration Observations

We estimate the variance $\sigma_e^2$ of the additive errors $e_{ijk}$'s (of the $k$th measurement at the $j$th concentration level in the $i$ th laboratory, $i=1,2,...,q, j = 1,2,...,r, k=1,2,...,N_{ij}$) that are present primarily at low-level concentrations and the calibration parameter $\alpha_i$ for the $i$th laboratory using low-concentration observations.

Assuming that observations corresponding to zero or near-zero are available. Let $y_{i0k}$ be the $k$th measured concentration corresponding to the true low-level concentration from laboratory $i$ and $n_{i0}$ is the number of samples with true low-level concentrations submitted to laboratory $i$:

(1) Estimate $\sigma_e^2$ by the variance of the observations with zero or near-zero concentrations ($y_{i0k}$) by

\begin{equation}
\hat{\sigma}_e^2 = \frac{1}{q} \displaystyle \sum_{i = 1}^{q} (\frac{\sum_{k=1}^{n_{i0}}(y_{i0k}-\bar{y}_{i0})^2}{n_{i0}-1})
\end{equation}

(2) Estimate $\alpha_i$ from the observations with zero or near-zero concentrations ($y_{i0k}$) by 

\begin{equation}
\hat{\alpha_i} = \frac{\sum_{k=1}^{n_{i0}}y_{i0k}}{n_{i0}}
\end{equation}

### (Partial) Estimation Using Higher-Concentration Observations

(1) Let $z_{ijk} = \frac{(y_{ijk}-\alpha_i)}{x_j}$ and $u_{ijk}=\frac{e_{ijk}}{xj}$.

Using the estimate $\hat{\alpha_i}$ of $\alpha_i$ we compute the $z_{ijk}$'s by

\begin{align}
\begin{split}
\label{eq8-1}
y_{ijk} &= \alpha_i + \beta_ix_je^{\eta_{ijk}} + e_{ijk} \\
y_{ijk} - \alpha_i &= \beta_ix_je^{\eta_{ijk}} + e_{ijk} \\
\frac{y_{ijk} - \alpha_i}{x_j} &= \beta_ie^{\eta_{ijk}} + \frac{e_{ijk}}{x_j} \ (\text{given} \ x_j's \ \text{have higher concentrations}) \\
z_{ijk} &= \beta_ie^{\eta_{ijk}} + \mu_{ijk} \\
\frac{z_{ijk}}{\beta_i} &= e^{\eta_{ijk}} + \frac{\mu_{ijk}}{\beta_i} \ (\text{given} \ \beta_i \neq 0).
\end{split}
\end{align}

(2) Let 

\begin{equation}
\gamma=E(e^{\eta})=e^{\sigma_{\eta}^2/2}, \ \mu_{zi}=E(z_{ijk}), \ \sigma_{zi}^2=\frac{\sum_{j=1}^rvar(z_{ijk})}{r}, \ \sigma_{\mu}^2=\frac{\sigma_e^2\sum_{j=1}^{r}1/x_j^2}{r}
\end{equation}

Using equation (\ref{eq8-1}) we can calculate

\begin{equation}
\label{eq10-1}
\frac{\mu_{zi}}{\beta_i} = \gamma \ \text{and} \ \frac{\sigma_{zi}^2}{\beta_i^2} = (\gamma^4-\gamma^2) + \frac{\sigma_\mu^2}{\beta_i^2}.
\end{equation}

(3) Replacing $\gamma$ by $\frac{\mu_{zi}}{\beta_i}$ in the second part of equation (\ref{eq10-1}) we obtain the following equation: 

\begin{equation}
\label{eq11-1}
\beta_i = \sqrt{\frac{\mu_{zi}^4}{\sigma_{zi}^2-\sigma_\mu^2+\mu_{zi}^2}} \ \text{and} \ \sigma_{\eta}^2 = \frac{2\sum_{i=1}^qln(\mu_{zi}/\beta_i)}{q}.
\end{equation}

To estimate $\beta_i$ and $\sigma_\eta$ from equation (\ref{eq11-1}), we need estimates of $\mu_{zi}, \ \sigma_{zi}^2,$ and $\sigma_\mu^2$ (the error variance of the model (\ref{eq8-1})).  

(4) Let $n_{ij}$ be the number of observations with higher concentrations collected from the $i$th laboratory for concentration level $j$ and $n_i =\sum_{j=1}^r\eta_{ij}$, then

\begin{align}
\begin{split}
\hat{\mu}_{z_{ij}}&=\frac{\sum_{k=1}^{n_{ij}}z_{ijk}}{n_{ij}}, \ \hat{\mu}_{z_i}=\frac{\sum_{j=1}^r\hat{\mu}_{z_{ij}}}{r}, \\
\hat{\sigma}_{zi}^2 &= \frac{\sum_{j=1}^{r} \sum_{k=1}^{\eta_{ij}} (z_{ijk}-\hat{\mu}_{z_{ij}})^2/(\eta_{ij}-1)}{r}, \ \hat{\sigma}_{\mu}^2 = \frac{\sum_{j=1}^r \hat{\sigma}_e^2/x_j^2}{r}
\end{split}
\end{align}

(5) Therefore We can calculate the estimates of the variance of the proportional error at higher true concentrations $\sigma_\eta^2$ and the calibration parameter $\beta_i$ for the $i$th laboratory as

\begin{equation}
\hat{\beta}_i=\sqrt{\frac{\hat{\mu}_{z_i}^4}{\hat{\sigma}^2_{z_i}-\hat{\sigma}_\mu^2+\hat{\mu}^2_{z_i}}} \ \text{and} \ \hat{\sigma}_{\eta}^2 = \frac{2\sum_{i=1}^qln(\hat{\mu}_{z_i}/\hat{\beta}_i)}{q} 
\end{equation}

```{r, echo = FALSE}
low <- p1.data[p1.data$Concentration == 0,]

ave <- 0
for (i in 1:max(low$Lab)) {
  ave[i] <- mean(low$Real[low$Lab == i])
}

low$y_mean <- rep(ave, each = max(low$Lab))

sigma_e2 <- 0
for (i in 1:max(low$Lab)) {
  sigma_i <- sum(sum((low$Real[low$Lab == i] - low$y_mean[low$Lab == i])^2) / 4) / 5
  sigma_e2 <- sigma_e2 + sigma_i
}

sigma_e2 # estimate of sigma_e2
alpha_i <- ave # estimates of alpha_i

low$alpha_i <- rep(alpha_i, each = max(low$Lab))

########################### estimation for the higher concentrations ######################
##################################### beta_i, sigma_eta2 ##################################

higher <- p1.data[p1.data$Concentration != 0, ]

for (i in 1:max(higher$Lab)) {
  higher$alpha_i[higher$Lab == i] <- alpha_i[i]
}


higher$z_ijk <- (higher$Real - higher$alpha_i) / higher$Concentration # z_ijk

twenty <- higher[higher$Concentration == 20,]
hundred <- higher[higher$Concentration == 100, ]

n_ij <- 5

mu_zij20 = 0
for (i in 1:max(twenty$Lab)) {
  mu_zij20[i] <- sum(twenty$z_ijk[twenty$Lab == i]) / n_ij
}
mu_zij20 # mu_zij for 100 ug / L

mu_zij100 = 0
for (i in 1:max(hundred$Lab)) {
  mu_zij100[i] <- sum(hundred$z_ijk[hundred$Lab == i]) / n_ij
}
mu_zij100 # mu_zij for 100 ug / L

mu_zi = (mu_zij20 + mu_zij100) / 2 
mu_zi # mu_zi

twenty$mu_zij <- rep(mu_zij20, each = max(twenty$Lab))
hundred$mu_zij <- rep(mu_zij100, each = max(hundred$Lab))

sigma_zi220 <- 0
for (i in 1:max(twenty$Lab)) {
  sigma_zi220[i] <- sum((twenty$z_ijk[twenty$Lab == i] - twenty$mu_zij[twenty$Lab == i])^2 / (n_ij - 1))
}

sigma_zi220 # sigma_zi220

sigma_zi2100 <- 0
for (i in 1:max(hundred$Lab)) {
  sigma_zi2100[i] <- sum((hundred$z_ijk[hundred$Lab == i] - hundred$mu_zij[hundred$Lab == i])^2 / (n_ij - 1))
}

sigma_zi2100 # sigma_zi2100

sigma_zi2 <- (sigma_zi220 + sigma_zi2100) / 2 

sigma_u2 <- sigma_e2 * (1 / 20^2 + 1 / 100^2) / 2 # sigma_u2

beta_i <- sqrt(mu_zi^4 / (sigma_zi2 - sigma_u2 + mu_zi^2))

beta_i # beta_i

low$beta_i <- rep(beta_i, each = max(low$Lab))
twenty$beta_i <- rep(beta_i, each = max(twenty$Lab))
hundred$beta_i <- rep(beta_i, each = max(hundred$Lab))

sigma_eta2 <- 2 * sum(log(mu_zi / beta_i)) / 5 # sigma_eta2

gamma <- exp(sigma_eta2 / 2)

# table of parameter estmates

# alpha_i: 
alpha_i
# beta_i:
beta_i
# mu_zij:
cbind(c('20 ug/L', '100 ug/L'),rbind(mu_zij20, mu_zij100))
# m_zi:
mu_zi
#sigma_zi:
sigma_zi2
# sigma_e2:
sigma_e2
# sigma_u2:
sigma_u2
# sigma_eta2:
sigma_eta2
# gamma:
gamma
```

## Point Estimation of $X$

Suppose that the same analyte with an unknown true concentration $X$ is tested in $q^{'}$ independent laboratories, and that $Y_1,Y_2,...,Y_{q^{'}}$ are the corresponding new observations. We want to compute a point estimate of $X$ using the available information from each of the $q^{'}$ laboratories and then combine them.

```{r, echo = TRUE}
########################### estimation of x ###############################
########## choose 1st observation of each lab as new observation ##########

## 0 ug / L

## point estimate 

y1 <- low[1,]
y2 <- low[6,]
y3 <- low[11,]

x <- function(y, alpha, beta, gamma) {
  xi_hat <- (y - alpha) / (beta * gamma)
}

x1 <- x(y1$Real, y1$alpha_i, y1$beta_i, gamma)
x2 <- x(y2$Real, y2$alpha_i, y2$beta_i, gamma)
x3 <- x(y3$Real, y3$alpha_i, y3$beta_i, gamma)
x_hat <- (x1 + x2 + x3) / 3
x_hat

## variance

variance <- (sigma_e2 / (y1$beta_i^2 * gamma^2)*(1 + 1 / 5) + sigma_e2 / (y2$beta_i^2 * gamma^2)*(1 + 1 / 5) +
                sigma_e2 / (y2$beta_i^2 * gamma^2)*(1 + 1 / 5)) / 3^2 + 
  0^2 * (gamma^2 - 1) / 3

## confidence interval
y_bar <- ( y1$Real + y2$Real + y3$Real ) / 3
sigma_alpha2 <- var(low$alpha_i)

cll <- max(0, y_bar - 1.96*sqrt((sigma_e2 + sigma_alpha2)/ 3))
clu <- y_bar + 1.96 * sqrt((sigma_e2 + sigma_alpha2) /3)

CL_low <- c(cll, clu)

# 20 ug / L

## point estimate

y12 <- twenty[1,]
y22 <- twenty[6,]
y32 <- twenty[11,]

x12 <- x(y12$Real, y12$alpha_i, y12$beta_i, gamma)
x22 <- x(y22$Real, y22$alpha_i, y22$beta_i, gamma)
x32 <- x(y32$Real, y32$alpha_i, y32$beta_i, gamma)
x_hat2 <- (x12 + x22 + x32) / 3
x_hat2

## variance

variance2 <- (sigma_e2 / (y12$beta_i^2 * gamma^2)*(1 + 1 / 5) + sigma_e2 / (y22$beta_i^2 * gamma^2)*(1 + 1 / 5) +
  sigma_e2 / (y32$beta_i^2 * gamma^2)*(1 + 1 / 5)) / 3^2 + 
  20^2 * (gamma^2 - 1) / 3

## confidence interval

X1 <- 20

c1i <- beta_i^2 * X1^2 * (gamma^4 - gamma^2) + sigma_e2
c2i <- c1i / (beta_i^2*X1^2)
c3i <- log((1 + sqrt(1 + 4*c2i)) / 2)

# 100 ug / L 

## point estimate

y13 <- hundred[1,]
y23 <- hundred[6,]
y33 <- hundred[11,]

x13 <- x(y13$Real, y13$alpha_i, y13$beta_i, gamma)
x23 <- x(y23$Real, y23$alpha_i, y23$beta_i, gamma)
x33 <- x(y33$Real, y33$alpha_i, y33$beta_i, gamma)
x_hat3 <- (x13 + x23 + x33) / 3
x_hat3

## variance

variance3 <- (sigma_e2 / (y13$beta_i^2 * gamma^2)*(1 + 1 / 5) + sigma_e2 / (y23$beta_i^2 * gamma^2)*(1 + 1 / 5) +
                sigma_e2 / (y33$beta_i^2 * gamma^2)*(1 + 1 / 5)) / 3^2 + 
  100^2 * (gamma^2 - 1) / 3

## confidence interval

X2 <- 100

c1i2 <- beta_i^2 * X2^2 * (gamma^4 - gamma^2) + sigma_e2
c2i2 <- c1i / (beta_i^2*X2^2)
c3i2 <- log((1 + sqrt(1 + 4*c2i)) / 2)

```

## Variance of $X$

Variance for $X$ is `r variance`, `r variance2`, `r variance3` for 0, 20, 100 $\mu g/L$ true concentration level, respectively.

## Confidence Interval of $X$

# Table/Discussion

```{r, echo = T}
## make a table

x <- matrix(c(x_hat, variance, x_hat2, variance2, x_hat3, variance3), 3, 2, byrow = T)
x <- as.matrix(cbind(c('0 ug/L', '20 ug/L', '100 ug/L'), round(x, 3)))
colnames(x) <- c('True Concentration','X_hat', 'Var(X)')
kable(x, format = 'pandoc')

```

# References

